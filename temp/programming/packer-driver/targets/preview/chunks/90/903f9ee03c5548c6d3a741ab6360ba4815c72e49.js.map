{"version":3,"sources":["file:///D:/game/FrameworkCocos/assets/vd-framework/ui/VDTouchHandler.ts"],"names":["CCBoolean","VDControlEvent","ccclass","property","cc","_decorator","VDTouchHandler","EventHandler","Component","_longPressed","_pressed","_lastHits","onEnable","_registerEvent","onDisable","_unregisterEvent","cancelTouch","node","on","Node","EventType","TOUCH_START","_onTouchBegan","TOUCH_MOVE","_onTouchMoved","TOUCH_END","_onTouchEnded","TOUCH_CANCEL","_onTouchCancelled","game","Game","EVENT_SHOW","off","event","enabledInHierarchy","touch","__instanceId","_hitTest","getLocation","emit","TouchDown","longClickEnabled","scheduleOnce","_longClickExec","bind","propagationStopped","hit","TouchDragEnter","TouchDragInside","TouchDragExit","TouchDragOutside","stopPropagation","emitEvents","touchEvent","ClickByTouchHandler","TouchUpInside","unscheduleAllCallbacks","TouchUpOutside","dt","LongClick","touchId","propagationImmediateStopped"],"mappings":"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","sourcesContent":["import * as cc from 'cc';\nimport { CCBoolean } from 'cc';\nimport VDControlEvent from './VDControlEvent';\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class VDTouchHandler extends cc.Component {\n    @property(cc.EventHandler)\n    touchEvent: cc.EventHandler = new cc.EventHandler();\n\n    @property(CCBoolean)\n    longClickEnabled = false;\n\n    private _longPressed: boolean = false;\n    private _pressed: boolean = false;\n    private _lastHits: any = {};\n\n    onEnable() {\n        this._registerEvent();\n    }\n\n    onDisable() {\n        this._unregisterEvent();\n        this.cancelTouch();\n    }\n\n    private _registerEvent() {\n        let node = this.node as any;\n        node.on(cc.Node.EventType.TOUCH_START, this._onTouchBegan, this);\n        node.on(cc.Node.EventType.TOUCH_MOVE, this._onTouchMoved, this);\n        node.on(cc.Node.EventType.TOUCH_END, this._onTouchEnded, this);\n        node.on(cc.Node.EventType.TOUCH_CANCEL, this._onTouchCancelled, this);\n        cc.game.on(cc.Game.EVENT_SHOW, this.cancelTouch, this);\n    }\n\n    private _unregisterEvent() {\n        let node = this.node as any;\n        node.off(cc.Node.EventType.TOUCH_START, this._onTouchBegan, this);\n        node.off(cc.Node.EventType.TOUCH_MOVE, this._onTouchMoved, this);\n        node.off(cc.Node.EventType.TOUCH_END, this._onTouchEnded, this);\n        node.off(cc.Node.EventType.TOUCH_CANCEL, this._onTouchCancelled, this);\n        cc.game.off(cc.Game.EVENT_SHOW, this.cancelTouch, this);\n    }\n\n    protected _onTouchBegan(event: cc.EventTouch): void {\n        if (!this.enabledInHierarchy) return;\n\n        let touch = event.touch as any;\n\n        let node = this.node as any;\n        this._lastHits[touch.__instanceId] = node._hitTest(touch.getLocation());\n        node.emit(VDControlEvent.TouchDown, touch);\n        this._pressed = true;\n        if (this.longClickEnabled) {\n            this.scheduleOnce(this._longClickExec.bind(this), 1.2);\n        }\n        event.propagationStopped = false;\n\n    }\n\n    protected _onTouchMoved(event: cc.EventTouch) {\n        if (!this.enabledInHierarchy ||\n            !this._pressed) return;\n\n        let touch = event.touch as any;\n\n        let node = this.node as any;\n        let hit = node._hitTest(touch.getLocation());\n        if (this._lastHits[touch.__instanceId] != hit) {\n            if (hit) {\n                this.node.emit(VDControlEvent.TouchDragEnter, touch);\n                this.node.emit(VDControlEvent.TouchDragInside, touch);\n            } else {\n                this.node.emit(VDControlEvent.TouchDragExit, touch);\n                this.node.emit(VDControlEvent.TouchDragOutside, touch);\n            }\n            this._lastHits[touch.__instanceId] = hit;\n        } else {\n            if (hit) {\n                this.node.emit(VDControlEvent.TouchDragInside, touch);\n            } else {\n                this.node.emit(VDControlEvent.TouchDragOutside, touch);\n            }\n        }\n        this.stopPropagation(event);\n    }\n\n    protected _onTouchEnded(event: cc.EventTouch) {\n        if (!this.enabledInHierarchy) return;\n\n        let touch = event.touch as any;\n\n        if (this._pressed) {\n            this._pressed = false;\n            if (!this._longPressed) {\n                cc.EventHandler.emitEvents([this.touchEvent], event);\n                this.node.emit(VDControlEvent.ClickByTouchHandler, touch);\n            } else {\n                this._longPressed = false;\n            }\n        }\n\n        this.node.emit(VDControlEvent.TouchUpInside, touch);\n\n        delete this._lastHits[touch.__instanceId];\n        this.stopPropagation(event);\n        this.unscheduleAllCallbacks();\n    }\n\n    protected _onTouchCancelled(event: cc.EventTouch) {\n        if (!this.enabledInHierarchy) return;\n\n        this._pressed = false;\n        this._longPressed = false;\n        let touch = event.touch as any;\n        this.node.emit(VDControlEvent.TouchUpOutside, touch);\n        delete this._lastHits[touch.__instanceId];\n        this.unscheduleAllCallbacks();\n    }\n\n    private _longClickExec(dt: number) {\n        if (this.longClickEnabled && this._pressed && !this._longPressed) {\n            this.node.emit(VDControlEvent.LongClick, this);\n            this._longPressed = true;\n        }\n    }\n\n    cancelTouch() {\n        this._pressed = false;\n        this._longPressed = false;\n        this.unscheduleAllCallbacks();\n        for (let touchId in this._lastHits) {\n            delete this._lastHits[touchId];\n        }\n    }\n\n    stopPropagation(event: cc.Event) {\n        event.propagationImmediateStopped = true;\n        event.propagationStopped = true;\n    }\n\n}"]}